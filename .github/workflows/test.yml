name: Test

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    name: Test on ${{ matrix.os }} with Node ${{ matrix.node }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node: ['18.x', '20.x', '22.x']
        exclude:
          # Skip Node 18 on Windows (--loader issues)
          - os: windows-latest
            node: '18.x'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
      
      - name: Display Node.js and Platform Info
        run: |
          node --version
          npm --version
          echo "OS: ${{ matrix.os }}"
          echo "Platform: ${{ runner.os }}"
      
      - name: Run E2E Real-World Tests
        run: npm run test:e2e
      
      - name: Run Integration Tests
        run: npm run test:integration
      
      - name: Run Config Tests
        run: npm run test:config
      
      - name: Run Filesystem Tests
        run: npm run test:filesystem
      
      - name: Run Network Tests
        run: npm run test:network
      
      - name: Run Environment Tests
        run: npm run test:environment
      
      - name: Run Behavioral Tests
        run: npm run test:behavioral
      
      - name: Run Mode Tests
        run: npm run test:modes
      
      - name: Run Exceptions Tests
        run: npm run test:exceptions
      
      - name: Run GitHub API Tests
        run: npm run test:github
      
      - name: Run Core Components Tests
        run: npm run test:core
      
      - name: Run Advanced Security Tests
        run: npm run test:advanced
      
      - name: Run Blocked Patterns Tests
        run: npm run test:patterns
      
      - name: Run Version Detection Tests
        run: npm run test:version-detection
      
      - name: Run Loader Selection Tests
        run: npm run test:loader-selection
